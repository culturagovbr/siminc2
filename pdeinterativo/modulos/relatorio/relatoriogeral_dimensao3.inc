<?php

$where[] = "p.pdistatus='A'";
$where2[] = "p.pdistatus='A'";

if($_REQUEST['intesfera']) {
	$where[] = "p.pdiesfera='".$_REQUEST['intesfera']."'";
	$where2[] = "p.pdiesfera='".$_REQUEST['intesfera']."'";
}

if($_REQUEST['estuf']) {
	$where[] = "m.estuf='".$_REQUEST['estuf']."'";
	$where2[] = "m.estuf='".$_REQUEST['estuf']."'";
}

if($_REQUEST['muncod']) {
	$where[] = "m.muncod='".$_REQUEST['muncod']."'";
	$where2[] = "m.muncod='".$_REQUEST['muncod']."'";
}

if($_REQUEST['prgsubmodulo']) {
	$where[] = "pe.prgsubmodulo='".$_REQUEST['prgsubmodulo']."'";
}

if($_REQUEST['prgdetalhe']) {
	$where[] = "pe.prgdetalhe='".$_REQUEST['prgdetalhe']."'";
}

if($_REQUEST['prgid']) {
	foreach($_REQUEST['prgid'] as $prgid) {
		$pp[] = $prgid;
	}
	$where[] = "pe.prgid in('".implode("','",$pp)."')";
}

echo '<table width="100%" border="0" cellpadding="0" cellspacing="0"  style="border-bottom: 1px solid;">
	  <tr bgcolor="#ffffff"> 
	  <td><img src="../imagens/brasao.gif" width="50" height="50" border="0"></td>
	  <td height="20" nowrap>
  	  '. NOME_SISTEMA. '<br>
	  Ministério da Educação / Secretaria de Educação Básica<br>
	  PDEInterativo<br>
	  3. Ensino e aprendizagem
	  </td>
	  <td height="20" align="right">
	  Impresso por: <strong>'.$_SESSION['usunome'].'</strong><br>
	  Hora da Impressão: '.date("d/m/Y").' - '.date("h:i:s").'<br>
	  <i>Filtros aplicados:</i><br>
	  '.(($_REQUEST['estuf'])?'<b>Estado:</b> '.$db->pegaUm('select estdescricao from territorios.estado where estuf=\''.$_REQUEST['estuf'].'\''):'').'<br> 
	  '.(($_REQUEST['muncod'])?'<b>Município:</b> '.$db->pegaUm('select mundescricao from territorios.municipio where muncod=\''.$_REQUEST['muncod'].'\''):'').'</td>
	  </tr>
	  <tr bgcolor="#ffffff"> 
      <td colspan="2">&nbsp;</td>
	  </tr>
	  </table>';

echo "<br>";
		
echo "<table class=tabela bgcolor=#f5f5f5 cellSpacing=1 cellPadding=3 align=center>";


echo "<tr>";
echo "<td class=SubTituloCentro>Resumo das Perguntas</td>";
echo "</tr>";

echo "<tr>";
echo "<td>";

$sql = "select count(pdicodinep) as total
			from pdeinterativo.pdinterativo p 
			inner join pdeinterativo.respostapergunta r on r.pdeid=p.pdeid 
			inner join pdeinterativo.pergunta pe on pe.prgid=r.prgid 
			inner join territorios.municipio m on m.muncod=p.muncod
			where prgmodulo='E' ".(($where)?" AND ".implode(" AND ",$where):"")."";
$totalescolas = $db->pegaUm($sql);

$sql = "select count(pdicodinep) as total
			from pdeinterativo.pdinterativo p 
			inner join pdeinterativo.respostapergunta r on r.pdeid=p.pdeid 
			inner join pdeinterativo.pergunta pe on pe.prgid=r.prgid 
			inner join territorios.municipio m on m.muncod=p.muncod
			where prgmodulo='E' and r.oppid=".OPP_SEMPRE." ".(($where)?" AND ".implode(" AND ",$where):"")."";
$total_sempre = $db->pegaUm($sql);

$sql = "select count(pdicodinep) as total
			from pdeinterativo.pdinterativo p 
			inner join pdeinterativo.respostapergunta r on r.pdeid=p.pdeid 
			inner join pdeinterativo.pergunta pe on pe.prgid=r.prgid 
			inner join territorios.municipio m on m.muncod=p.muncod
			where prgmodulo='E' and r.oppid=".OPP_MAIORIA_DAS_VEZES." ".(($where)?" AND ".implode(" AND ",$where):"")."";
$total_maioriadasvezes = $db->pegaUm($sql);

$sql = "select count(pdicodinep) as total
			from pdeinterativo.pdinterativo p 
			inner join pdeinterativo.respostapergunta r on r.pdeid=p.pdeid 
			inner join pdeinterativo.pergunta pe on pe.prgid=r.prgid 
			inner join territorios.municipio m on m.muncod=p.muncod
			where prgmodulo='E' and r.oppid=".OPP_RARAMENTE." ".(($where)?" AND ".implode(" AND ",$where):"")."";
$total_raramente = $db->pegaUm($sql);
$sql = "select count(pdicodinep) as total
			from pdeinterativo.pdinterativo p 
			inner join pdeinterativo.respostapergunta r on r.pdeid=p.pdeid 
			inner join pdeinterativo.pergunta pe on pe.prgid=r.prgid 
			inner join territorios.municipio m on m.muncod=p.muncod
			where prgmodulo='E' and r.oppid=".OPP_NUNCA." ".(($where)?" AND ".implode(" AND ",$where):"")."";
$total_nunca = $db->pegaUm($sql);



echo "<table class=listagem width=100% bgcolor=#f5f5f5 cellSpacing=1 cellPadding=3 align=center>";
echo "<tr><td class=SubTituloDireita>Sempre</td><td>".$total_sempre." / ".round(($total_sempre/$totalescolas)*100,1)."%</td></tr>";
echo "<tr><td class=SubTituloDireita>A maioria das vezes</td><td>".$total_maioriadasvezes." / ".round(($total_maioriadasvezes/$totalescolas)*100,1)."%</td></tr>";
echo "<tr><td class=SubTituloDireita>Raramente</td><td>".$total_raramente." / ".round(($total_raramente/$totalescolas)*100,1)."%</td></tr>";
echo "<tr><td class=SubTituloDireita>Nunca</td><td>".(($total_nunca)?$total_nunca:"0")." / ".round(($total_nunca/$totalescolas)*100,1)."%</td></tr>";
echo "</table>";

echo "</td>";
echo "</tr>";



echo "<tr>";
echo "<td class=SubTituloCentro>Perguntas</td>";
echo "</tr>";
		
echo "<tr>";
echo "<td>";
$sql = "select CASE WHEN prgsubmodulo='P' THEN '3.1. Planejamento Pedagógico'
					WHEN prgsubmodulo='T' THEN '3.2. Tempo de Aprendizagem' END as submodulo, 
			   pdicodinep, pdenome, prgdetalhe, prgdesc, 
				case when r.oppid=".OPP_SEMPRE." then '<center>X</center>' else '' end as sempre,
				case when r.oppid=".OPP_MAIORIA_DAS_VEZES." then '<center>X</center>' else '' end as maioria,
				case when r.oppid=".OPP_RARAMENTE." then '<center>X</center>' else '' end as raramente,
				case when r.oppid=".OPP_NUNCA." then '<center>X</center>' else '' end as nunca 
				from pdeinterativo.pdinterativo p 
				inner join pdeinterativo.respostapergunta r on r.pdeid=p.pdeid 
				inner join pdeinterativo.pergunta pe on pe.prgid=r.prgid 
				inner join territorios.municipio m on m.muncod=p.muncod
				where prgmodulo='E' ".(($where)?" AND ".implode(" AND ",$where):"")." 
				order by submodulo, pdenome, prgdetalhe, prgdesc";
		
$cabecalho = array("Subdimensão","INEP","Escola","Tema","Pergunta","Sempre","A maioria das vezes","Raramente","Nunca");
$db->monta_lista_simples($sql,$cabecalho,1000000,5,'N','100%',$par2);
		
echo "</td>";
echo "</tr>";
		
echo "<tr>";
echo "<td class=SubTituloCentro>Relatório Educação Integral - SIM, a escola realiza ações de Educação Integral</td>";
echo "</tr>";
	
echo "<tr>";
echo "<td>";

$sql = "select pdicodinep, pdenome, 
		REPLACE(REPLACE(REPLACE(rtaestrategia,'P','Programa Mais Educação'),'I','Iniciativa Estadual/Municipal'),'O','Outras') as estrategia, 
		SUBSTR(rtaestudantepart,1,(position(';' in rtaestudantepart)-1)) as qtd1, 
		SUBSTR(rtaestudantepart,(position(';' in rtaestudantepart)+1)) as qtd2, 
		rtacargahoraria, 
		REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(rtamacrocampo,'acompanhamentopedagogico','Acompanhamento pedagógico'),'educacaoambiental','Educação ambiental'),'esportelazer','Esporte e lazer'),'direitoshumanoseducacao','Direitos humanos em educação'),'culturaartes','Cultura e artes'),'culturadigital','Cultura digital'),'promocaosaude','Promoção da saúde'),'comunicacaousomidias','Comunicação e uso de mídias'),'educacaoeconomica','Educação econômica') as rtamacrocampo 
		from pdeinterativo.pdinterativo p 
		inner join pdeinterativo.respostatempoaprendizagem r on r.pdeid = p.pdeid 
		inner join territorios.municipio m on m.muncod=p.muncod  
		where pdistatus='A' and rtastatus='A' and rtacaso='S' ".(($where2)?"AND ".implode(" AND ",$where2):"");

$cabecalho = array("INEP","Escola","Estratégia","Estudantes da escola","Estudantes de outras escolas","Carga horária","Macrocampos");
$db->monta_lista_simples($sql,$cabecalho,1000000,5,'N','100%',$par2);

echo "</td>";
echo "</tr>";

echo "<tr>";
echo "<td class=SubTituloCentro>Relatório Educação Integral - NÃO, a escola não realiza ações de Educação Integral</td>";
echo "</tr>";
	
echo "<tr>";
echo "<td>";

$sql = "select pdicodinep, pdenome, 
		CASE WHEN position('espacofisico' in rtaporque)>0 THEN '<center>X</center>' ELSE '' END as espacofisico,
		CASE WHEN position('profissionais' in rtaporque)>0 THEN '<center>X</center>' ELSE '' END as profissionais, 
		CASE WHEN position('recursosmateriais' in rtaporque)>0 THEN '<center>X</center>' ELSE '' END as recursosmateriais, 
		CASE WHEN position('outro' in rtaporque)>0 THEN '<center>X</center>' ELSE '' END as outro 
		from pdeinterativo.pdinterativo p 
		inner join pdeinterativo.respostatempoaprendizagem r on r.pdeid = p.pdeid 
		inner join territorios.municipio m on m.muncod=p.muncod 
		where pdistatus='A' and rtastatus='A' and rtacaso='N' ".(($where2)?"AND ".implode(" AND ",$where2):"");

$cabecalho = array("INEP","Escola","Não possui espaço físico","Não dispoe de profissionais para coordenar as atividades","Não dispoe de recursos materiais","Outro");
$db->monta_lista_simples($sql,$cabecalho,1000000,5,'N','100%',$par2);

echo "</td>";
echo "</tr>";

	
echo "</table>";


?>